{% extends "base.html" %}
{% block title %}ุงูููุชุจุฉ ุงูุฑูููุฉ{% endblock %}
{% block content %}
<section class="all-page">
    <div class="container">
        <div class="section-header text-center mb-5">
            <h2 style="font-weight: 800; color: #2d3748;">ุงูููุชุจุฉ ุงูุฑูููุฉ</h2>
            <p class="text-muted">ูุดุฑ ุงููุนุฑูุฉ ุจูู ุงูุฃูุฑุงุฏ </p>
        </div>
        <div class="search-container">
            <form action="/library/" method="GET" class="search-form">
                <input type="hidden" name="category" value="{{ selected_category }}">
                <input type="text" name="q" class="search-input" 
                    placeholder="ุงุจุญุซ ุนู ูุชุงุจ ุฃู ูุคูู..." value="{{ q if q else '' }}">
                <button type="submit" class="search-button">
                    <i class="fas fa-search">ุงุจุญุซ</i>
                </button>
            </form>
            {% if q %}
            <div class="text-center mt-2">
                <small class="text-muted">ูุชุงุฆุฌ ุงูุจุญุซ ุนู: <strong>{{ q }}</strong></small>
                <a href="/library/?category={{ selected_category }}" class="text-danger ms-2" style="font-size: 0.8rem;">ุฅูุบุงุก ุงูุจุญุซ</a>
            </div>
            {% endif %}
        </div>
        <div class="category-filter">
            <a href="/library/?category=ุงููู" class="filter-btn {% if selected_category == 'ุงููู' %}active{% endif %}">ุงููู</a>
            {% for cat in categories %}
            <a href="/library/?category={{ cat }}" class="filter-btn {% if selected_category == cat %}active{% endif %}">{{ cat }}</a>
            {% endfor %}
        </div>

        <div class="books-grid">
            {% for book in books %}
            <div class="book-card">
                <div class="book-cover-wrapper">
                    {# ุณูุณุชุฎุฏู ุงูุบูุงู ุงููุณุชุฎุฑุฌ ุงูุฐู ุฑูุนูุงู ูุฏููุงู #}
                    <img src="{{ book.cover_url }}" class="book-cover" alt="{{ book.title }}"
                        onerror="this.src='https://res.cloudinary.com/demo/image/upload/v1/sample.jpg'">
                    
                    <div class="book-overlay">
                        <a href="/library/view/{{ book.id }}" class="btn-quick-view">ูุฑุงุกุฉ ุงูุขู</a>
                    </div>
                </div>
              
                <div class="book-info">
                    <h3 class="book-title">{{ book.title }}</h3>
                    <p class="book-author">{{ book.author }}</p>
                </div>

                <div class="book-meta">
                    <span><i class="fas fa-layer-group"></i> {{ book.category }}</span>
                    <span><i class="fas fa-file-alt"></i> {{ book.file_size }}</span>
                </div>

                <div class="book-actions">
                    {% if book.file_url == 'pending' %}
                        <button class="btn-pending">
                            <i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุฑูุน...
                        </button>
                    {% elif book.file_url == 'error' %}
                        <div class="alert alert-danger py-1 px-2 mb-2 text-center" style="font-size: 0.8rem;">
                            <i class="fas fa-exclamation-circle"></i> ูุดู ุงูุฑูุน
                        </div>
                        {# ุฃุฒุฑุงุฑ ุงูุฅุฏุงุฑุฉ ูู ุญุงูุฉ ุงูุฎุทุฃ ูุฅุตูุงุญ ุงูุจูุงูุงุช ุฃู ุงูุญุฐู #}
                        {% if user.role == 'admin' or can_add %}
                        <div class="admin-actions-row">
                            <a href="/library/edit/{{ book.id }}" class="btn-edit-full">
                                <i class="fas fa-edit"></i> ุชุนุฏูู
                            </a>
                            <form action="/library/delete/{{ book.id }}" method="POST" 
                                onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุฌูุ');" style="flex: 1;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="submit" class="btn-delete-full" style="width: 100%;">
                                    <i class="fas fa-trash-alt"></i> ุญุฐู
                                </button>
                            </form>
                        </div>
                        {% endif %}

                    {% else %}
                       {# ุงูุญุงูุฉ ุงูุทุจูุนูุฉ: ุงูุฑูุน ูุงุฌุญ #}
                        <div class="action-buttons-row">
                            <a href="/library/view/{{ book.id }}" class="btn-read" target="_blank">
                                <span><i class="fas fa-eye"></i> ูุฑุงุกุฉ</span>
                                <small>({{ book.views_count or 0 }})</small>
                            </a>

                            {% if book.allow_download or user.role == 'admin' %}
                                <a href="/library/download/{{ book.id }}" class="btn-download-new">
                                    <span>
                                        <i class="fas {% if not book.allow_download %}fa-unlock-alt{% else %}fa-download{% endif %}"></i> 
                                        ุชุญููู
                                    </span>
                                    <small>({{ book.downloads_count or 0 }})</small>
                                    
                                    {% if user.role == 'admin' and not book.allow_download %}
                                        <span class="admin-badge-text">(ุฎุงุต ุจุงูุฃุฏูู)</span>
                                    {% endif %}
                                </a>
                            {% else %}
                                <button class="btn-download-new" style="background: #f1f5f9; color: #94a3b8; border: 1px solid #e2e8f0; cursor: not-allowed;">
                                    <i class="fas fa-lock"></i> 
                                    <span>ูุบูู</span>
                                </button>
                            {% endif %}
                        </div>

                        {% if user.role == 'admin' or can_add %}
                        <div class="admin-actions-row">
                            <a href="/library/edit/{{ book.id }}" class="btn-edit-full">
                                <i class="fas fa-edit"></i> ุชุนุฏูู
                            </a>
                            <form action="/library/delete/{{ book.id }}" method="POST" onsubmit="return confirm('ุญุฐู ููุงุฆูุ');" style="flex: 1;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="submit" class="btn-delete-full" style="width: 100%;">
                                    <i class="fas fa-trash-alt"></i> ุญุฐู
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="text-center w-100 py-5">
                <p class="text-muted">ูุง ุชูุฌุฏ ูุชุจ ูุชุงุญุฉ ูู ูุฐุง ุงููุณู ุญุงููุงู.</p>
            </div>
            {% endfor %}
        </div>
        {% if total_pages > 1 %}
        <div class="card-footer d-flex justify-content-center bg-transparent border-0 my-3">
            <nav aria-label="ุชุฑููู ุงูููุชุจุฉ">
                <ul class="pagination pagination-sm shadow-sm">
                    {# ุชุฌููุฒ ูุชุบูุฑุงุช ุงูุจุญุซ ูุงููุฆุฉ ูุถูุงู ุนุฏู ุถูุงุน ุงูููุชุฑุฉ ุนูุฏ ุงูุชููู #}
                    {% set query_params = "&category=" + selected_category %}
                    {% if q %}{% set query_params = query_params + "&q=" + q %}{% endif %}

                    {# ุฒุฑ ุงูุตูุญุฉ ุงูุณุงุจูุฉ #}
                    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="/library/?page={{ current_page - 1 }}{{ query_params }}">ุงูุณุงุจู</a>
                    </li>

                    {# ุงูุชุฑููู ุงูุฐูู #}
                    {% for p in page_numbers %}
                        <li class="page-item {% if p == current_page %}active{% endif %} 
                            {# ุฅุฎูุงุก ุงูุฃุฑูุงู ุงููุชูุณุทุฉ ูู ุงูููุจุงูู ูุนุฏู ุชูุฏุฏ ุงูุดุงุดุฉ #}
                            {% if p != current_page and p != 1 and p != total_pages %}
                                d-none d-sm-inline-block 
                            {% endif %}">
                            <a class="page-link" href="/library/?page={{ p }}{{ query_params }}">{{ p }}</a>
                        </li>
                    {% endfor %}

                    {# ุฒุฑ ุงูุตูุญุฉ ุงูุชุงููุฉ #}
                    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="/library/?page={{ current_page + 1 }}{{ query_params }}">ุงูุชุงูู</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</section>
{% if can_add %}
<a href="/library/add" class="add-btn-fixed"id="floatingAddBtn" title="ุฅุถุงูุฉ ูุชุงุจ ุฌุฏูุฏ" >
    <i class="fas fa-plus">ุงุถุงูุฉ</i>
</a>
{% endif %}

<script>
    // ูุฑุงูุจุฉ ุงูุฑูุน ุจุดูู ุฐูู ููููุฑ ููููุงุฑุฏ
    async function monitorUploads() {
        const pendingBooks = document.querySelectorAll('.btn-pending');
        if (pendingBooks.length === 0) return; // ูุง ููุฌุฏ ุฑูุนุ ูุง ุฏุงุนู ูุฅุฒุนุงุฌ ุงูุณูุฑูุฑ

        console.log("๐ ูุฑุงูุจุฉ ุนูููุงุช ุงูุฑูุน ุงูุฌุงุฑูุฉ...");
        
        const interval = setInterval(async () => {
            try {
                // ูููู ุจุฌูุจ ุงูุตูุญุฉ ูููู ููุญุต ููุท ุงูุนูุงุตุฑ ุงููุทููุจุฉ
                const response = await fetch(window.location.href, { cache: "no-store" });
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const stillPending = doc.querySelectorAll('.btn-pending').length;
                
                // ุฅุฐุง ุชุบูุฑ ุนุฏุฏ ุงููุชุจ ุงูุชู ุชุญุช ุงูุฑูุนุ ูููู ุจุชุญุฏูุซ ุงูุตูุญุฉ
                if (stillPending < pendingBooks.length) {
                    console.log("โ ุงูุชูู ุฑูุน ุฃุญุฏ ุงููุชุจุ ุฌุงุฑู ุชุญุฏูุซ ุงูููุชุจุฉ...");
                    clearInterval(interval);
                    window.location.reload(); 
                }
            } catch (error) { 
                console.error("ุฎุทุฃ ูู ูุฑุงูุจุฉ ุงูุฑูุน:", error);
                clearInterval(interval); // ุงูุชููู ุนูุฏ ุญุฏูุซ ุฎุทุฃ ูุชูุฑุฑ
            }
        }, 10000); // ุฒูุงุฏุฉ ุงููุฏุฉ ูู 10 ุซูุงูู ูุชูููู ุงูุถุบุท ุนูู ุงูุณูุฑูุฑ
    }

    // 2. ุงูุชุญููู ุงูุฐูู: ูุญุงููุฉ ุฅุฌุจุงุฑ ุงููุชุตูุญ ุนูู ุงูุงุณู ุงูุนุฑุจู
    async function downloadWithFriendlyName(event, url, title) {
        // ูุชุฑู ุงูุฑุงุจุท ุงูุงูุชุฑุงุถู ูุนูู ูุฒูุงุฏุฉ ุงูุนุฏุงุฏ ูู ุงูุณูุฑูุฑ
        // ุฎุงุตูุฉ download ูู HTML ุณุชููู ุจุงูุจุงูู ูู ุฃุบูุจ ุงููุชุตูุญุงุช
        console.log("ุฌุงุฑู ุงูุชุญููู ุจุงุณู:", title);
    }

    // 3. ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช: ุชุบููุฑ ุงูุฃุฑูุงู ููุฑุงู ุนูุฏ ุงูุถุบุท (ุจุฏูู Refresh)
    function setupCounterUpdates() {
    document.querySelectorAll('.btn-download-new, .btn-read').forEach(button => {
        button.addEventListener('click', function(e) {
            // 1. ุชุญุฏูุฏ ุงูู span ุงูุตุญูุญ ุจูุงุกู ุนูู ููุน ุงูุฒุฑ
            const isDownload = this.classList.contains('btn-download-new');
            const counterSpan = isDownload ? this.querySelector('.download-count') : this.querySelector('.read-count');
            
            if (counterSpan) {
                // 2. ุชุญุฏูุซ ุจุตุฑู ุณุฑูุน
                let currentCount = parseInt(counterSpan.innerText) || 0;
                counterSpan.innerText = currentCount + 1;

                // 3. ุฌูุจ ุงูุฑูู ุงูุฏููู ูู ุงูุณูุฑูุฑ ุจุนุฏ ุซุงููุฉ
                setTimeout(async () => {
                    try {
                        const response = await fetch(window.location.href);
                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // ูุจุญุซ ุนู ููุณ ุงูุฒุฑ ูู ุงูุตูุญุฉ ุงูุฌุฏูุฏุฉ ููุงุฎุฐ ููู ุงูุฑูู ููุท
                        const newBtn = doc.querySelector(`[href="${this.getAttribute('href')}"]`);
                        const newNum = isDownload ? newBtn.querySelector('.download-count') : newBtn.querySelector('.read-count');
                        
                        if (newNum) counterSpan.innerText = newNum.innerText;
                    } catch (error) { console.error("Error updating counter:", error); }
                }, 1500);
            }
        });
    });
}

    // ุชุดุบูู ูู ุงููุธุงุฆู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', () => {
        monitorUploads();
        setupCounterUpdates();
    });
</script>
{% endblock %}