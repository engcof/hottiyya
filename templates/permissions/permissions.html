{% extends "base.html" %}
{% block title %}لوحة الصلاحيات {% endblock %}

{% block content %}
<!-- CSS لضمان تطبيق انتقال سلس وموثوق لرسائل الفلاش -->
<style>
    /* تعريف خصائص الانتقال (Transition) لكل الرسائل */
    .flash-message {
        opacity: 1;
        /* نضمن أن يتأثر الارتفاع والشفافية لإزالة المساحة بالكامل */
        transition: opacity 0.5s ease-in-out, height 0.5s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out;
    }
    
    /* الفئة التي تطبق عند بدء الاختفاء */
    .flash-message.hidden {
        opacity: 0;
        /* إزالة المساحة لضمان صعود العناصر الأخرى بسلاسة ومنع التشتت البصري */
        height: 0; 
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
        margin-bottom: 0;
    }
</style>

<section class="all-page">
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">لوحة الصلاحيات</h1>
            <p class="page-subtitle">إدارة الصلاحيات بكل سهولة وأمان</p>
        </div>

        <!-- رسائل النجاح أو الخطأ - تم تعديلها لتتوافق مع الموجهات وتدعم الاختفاء التلقائي -->
        {% if success_message %}
            <div class="alert success flash-message">
                <p>✅ **تم بنجاح:** {{ success_message | safe }}</p>
            </div>
        {% endif %}
        {% if error_message %}
            <div class="alert error flash-message">
                <p>❌ **خطأ في الإجراء:** {{ error_message | safe }}</p>
            </div>
        {% endif %}

        <div class="admin-grid">
            <!-- بطاقة إضافة صلاحية جديدة -->
            <div class="admin-card">
                <h2>إضافة صلاحية جديدة</h2>
                <form method="post" action="/permissions/add_permission" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <!-- حقل رقم الصفحة لضمان العودة للموقع الصحيح -->
                    <input type="hidden" name="current_page" value="{{ current_page }}">
                    <div class="form-group">
                        <label>اسم الصلاحية</label>
                        <input type="text" name="name" required placeholder="أدخل اسم الصلاحية">
                    </div>
                    <div class="form-group">
                        <label>التصنيف</label>
                        <input type="text" name="category" required placeholder="مثال : عام">
                    </div>
                    
                    <button type="submit" class="submit-btn large">إضافة الصلاحية</button>
                </form>
               
            </div>  
             <!-- بطاقة التعديل المجمَّع (تم تبسيطها) -->
             <div class="admin-card">
                <h2>تعديل الصلاحيات</h2>
                <p class="subtitle">استخدم هذا القسم لتعديل صلاحية موجودة أو استخدم التعديل المباشر في الجدول.</p>

                <!-- نموذج تعديل صلاحية موجودة -->
                <form method="post" action="/permissions/edit_permission" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <!-- حقل رقم الصفحة لضمان العودة للموقع الصحيح -->
                    <input type="hidden" name="current_page" value="{{ current_page }}">

                    <div class="form-group">
                        <label>اختر الصلاحية لتعديلها</label>
                        <select name="perm_id" class="small-select" required>
                            <option value="">-- اختر صلاحية --</option>
                            <!-- نستخدم all_permissions لأن perms هي فقط لصفحة الترقيم الحالية -->
                            {% for p in all_permissions %}
                            <option value="{{ p.id }}">
                                {{ p.name }} ({{ p.category }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>اسم الصلاحية الجديد</label>
                        <input type="text" name="name" required placeholder="اسم الصلاحية">
                    </div>

                    <div class="form-group">
                        <label>التصنيف الجديد</label>
                        <input type="text" name="category" required placeholder="مثال: عام، مقالات، تعليقات">
                    </div>
                    
                    <button type="submit" class="submit-btn large"> تعديل الصلاحية</button>
                </form>
            </div>   
        </div>

        <!-- جدول المستخدمين الكامل -->
        <div class="admin-card full">
            <h2>قائمة الصلاحيات</h2>
            <div class="table-wrapper">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>اسم الصلاحية</th>
                            <th>التصنيف</th>
                            <th>تعديل اسم</th>
                            <th>تعديل صنف</th>
                            <th>الاجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for perm in perms %}
                        <tr>
                            <td>
                                <strong>{{ perm[1] }}</strong>
                            </td>
                            <td>
                               <strong>{{ perm[2] }}</strong>
                            </td>
                            <!-- عمود اسم الصلاحية (قابل للتعديل) -->
                            <!-- تم إضافة حقل مخفي للتصنيف لضمان تمريره مع الاسم -->
                            <td>
                                <form method="post" action="/permissions/edit_permission" id="edit-name-form-{{ perm[0] }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="perm_id" value="{{ perm[0] }}">
                                    <input type="hidden" name="category" value="{{ perm[2] }}">
                                    <input type="hidden" name="current_page" value="{{ current_page }}">
                                    <input type="text" name="name" value="{{ perm[1] }}" class="inline-input" required>
                                    <button type="submit" class="btn-small edit inline-save-btn">حفظ</button>
                                </form>
                            </td>

                            <!-- عمود التصنيف (قابل للتعديل) -->
                            <!-- تم إضافة حقل مخفي للاسم لضمان تمريره مع التصنيف -->
                            <td>
                                <form method="post" action="/permissions/edit_permission" id="edit-category-form-{{ perm[0] }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="perm_id" value="{{ perm[0] }}">
                                    <input type="hidden" name="name" value="{{ perm[1] }}">
                                    <input type="hidden" name="current_page" value="{{ current_page }}">
                                    <input type="text" name="category" value="{{ perm[2] }}" class="inline-input" required>
                                    <button type="submit" class="btn-small edit inline-save-btn">حفظ</button>
                                </form>
                            </td>
                            
                            <!-- عمود الأزرار: حذف -->
                            <td class="actions-cell">
                                <!-- زر الحذف - تم إزالة onsubmit="return confirm(...)" واستبدالها بإرسال Form مباشر -->
                                <form method="post" action="/permissions/delete_permission" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="perm_id" value="{{ perm[0] }}">
                                    <input type="hidden" name="current_page" value="{{ current_page }}">
                                    <button type="submit" class="btn-small delete">حذف</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
             <!-- ترقيم الصفحات -->
            <div class="pagination">
                {% if current_page > 1 %}
                <a href="/permissions?page={{ current_page - 1 }}" class="page-btn">السابق</a>
                {% endif %}
                <span class="page-info">الصفحة {{ current_page }} من {{ total_pages }}</span>
                {% if current_page < total_pages %}
                <a href="/permissions?page={{ current_page + 1 }}" class="page-btn">التالي</a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- جافاسكريبت للإخفاء التلقائي لرسائل الفلاش - لضمان عملها بعد 5 ثواني -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // تحديد جميع العناصر التي تحمل الفئة 'flash-message'
        const flashMessages = document.querySelectorAll('.flash-message');
        const DURATION = 5000; // 5000 مللي ثانية = 5 ثوانٍ

        flashMessages.forEach(message => {
            // إخفاء الرسالة بعد 5 ثوانٍ
            setTimeout(() => {
                // خطوة 1: تطبيق فئة CSS "hidden" لجعلها تختفي بسلاسة
                message.classList.add('hidden');
                
                // خطوة 2: إزالة الرسالة بالكامل من DOM بعد انتهاء الحركة (0.5 ثانية)
                setTimeout(() => {
                    message.remove();
                }, 500); 
            }, DURATION);
        });
        
        // منع استخدام confirm() المحظورة واستبدالها بحذف مباشر
        document.querySelectorAll('form[onsubmit*="confirm"]').forEach(form => {
            // إزالة onsubmit لتفادي رسالة التحذير المحظورة
            form.removeAttribute('onsubmit'); 
            // يمكن إضافة modal مخصص هنا إذا لزم الأمر
        });
    });
</script>
{% endblock %}