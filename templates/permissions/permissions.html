{% extends "base.html" %}
{% block title %}لوحة الصلاحيات {% endblock %}

{% block content %}
<section class="admin-dashboard">
    <div class="container">
        <div class="dashboard-header">
            <h1 class="page-title">لوحة الصلاحيات</h1>
            <p class="subtitle">إدارة الصلاحيات بكل سهولة وأمان</p>
        </div>

        <!-- رسائل النجاح أو الخطأ -->
        {% if success %}
            <div class="alert success">تم الإجراء بنجاح!</div>
        {% endif %}
        {% if error %}
            <div class="alert error">{{ error }}</div>
        {% endif %}

        <div class="admin-grid">
            <div class="admin-card">
                <h2>إضافة صلاحية جديد</h2>
                <form method="post" action="/permissions/add_permission" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="form-group">
                        <label>اسم الصلاحية</label>
                        <input type="text" name="name" required placeholder="أدخل اسم الصلاحية">
                    </div>
                    <div class="form-group">
                        <label>التصنيف</label>
                        <input type="text" name="category" required placeholder="مثال : عام">
                    </div>
                    
                    <button type="submit" class="submit-btn large">إضافة الصلاحية</button>
                </form>
               
            </div>  
             <div class="admin-card">
                <h2>تعديل الصلاحية: <strong>{{ perms.name }}</strong></h2>

                <form method="post" action="/permissions/edit_permission" class="admin-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="perm_id" value="{{ perms.id}}">

                    <div class="form-group">
                        <label>اختر الصلاحية لتعديلها</label>
                        <select name="perm_id" class="small-select" >
                            <option value="">-- اختر صلاحية --</option>
                            {% for p in all_permissions %}
                            <option value="{{ p.id }}" {% if p.id == perms.id %}selected{% endif %}>
                                {{ p.name }} ({{ p.category }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>اسم الصلاحية الجديد</label>
                        <input type="text" name="name" value="{{ perms.name }}" required placeholder="اسم الصلاحية">
                    </div>

                    <div class="form-group">
                        <label>التصنيف</label>
                        <input type="text" name="category" value="{{ perms.category }}" required placeholder="مثال: عام، مقالات، تعليقات">
                    </div>
               
                
               
                    
                    <button type="submit" class="submit-btn large"> تعديل الصلاحية</button>
                </form>
                
            </div>   
        </div>

        <!-- جدول المستخدمين الكامل -->
        <div class="admin-card full">
            <h2>قائمة الصلاحيات</h2>
            <div class="table-wrapper">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>اسم الصلاحية</th>
                            <th>التصنيف</th>
                            <th>تعديل اسم</th>
                            <th>تعديل صنف</th>
                            <th>الاجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for perm in perms %}
                        <tr>
                            <td>
                                <strong>{{ perm[1] }}</strong>
                            </td>
                            <td>
                               <strong>{{ perm[2] }}</strong>
                            </td>
                            <!-- عمود اسم الصلاحية (قابل للتعديل) -->
                            <td>
                                <form method="post" action="/permissions/edit_permission" class="inline-edit-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="perm_id" value="{{ perm[0] }}">
                                    <input type="text" name="name" value="{{ perm[1] }}" class="inline-input" required>
                                </form>
                            </td>

                            <!-- عمود التصنيف (قابل للتعديل) -->
                            <td>
                                <form method="post" action="/permissions/edit_permission" class="inline-edit-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="perm_id" value="{{ perm[0] }}">
                                    <input type="text" name="category" value="{{ perm[2] }}" class="inline-input" required>
                                </form>
                            </td>
                            <!-- عمود الأزرار: تعديل + حذف -->
                            <td class="actions-cell">
                                <div class="action-buttons">
                                    <!-- زر حفظ التعديل (للاسم أو التصنيف) -->
                                    <button type="submit" form="edit-form-{{ perm[0] }}" class="btn-small edit">
                                        حفظ
                                    </button>

                                    <!-- فورم منفصل للحفظ -->
                                    <form id="edit-form-{{ perm[0] }}" method="post" action="/permissions/edit_permission" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                        <input type="hidden" name="perm_id" value="{{ perm[0] }}">
                                        <input type="hidden" name="name" value="{{ perm[1] }}">
                                        <input type="hidden" name="category" value="{{ perm[2] }}">
                                    </form>

                                    <!-- زر الحذف -->
                                    <form method="post" action="/permissions/delete_permission" 
                                        onsubmit="return confirm('هل أنت متأكد من حذف {{ perm[1] }} نهائيًا؟')" 
                                        style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                        <input type="hidden" name="perm_id" value="{{ perm[0] }}">
                                        <button type="submit" class="btn-small delete">حذف</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
             <!-- ترقيم الصفحات -->
            <div class="pagination">
                {% if current_page > 1 %}
                <a href="/permissions?page={{ current_page - 1 }}" class="page-btn">السابق</a>
                {% endif %}
                <span class="page-info">الصفحة {{ current_page }} من {{ total_pages }}</span>
                {% if current_page < total_pages %}
                <a href="/permissions?page={{ current_page + 1 }}" class="page-btn">التالي</a>
                {% endif %}
            </div>
        </div>
    </div>
</section>

{% endblock %}