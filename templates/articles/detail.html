{% extends "base.html" %}
{% block title %}{{ article.title }} - المقالات{% endblock %}

{% block content %}
<section class="article-single-section">
    <div class="container">
        <!-- رجوع + أزرار التحكم -->
        <div class="article-actions-top">
            <a href="/articles" class="btn-back">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
                رجوع إلى المقالات
            </a>

            <div class="article-controls">
                {% if can_edit %}
                <a href="/articles/edit/{{ article.id }}" class="btn-edit">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    تعديل المقال
                </a>
                {% endif %}

                {% if can_delete %}
                <form action="/articles/delete/{{ article.id }}" method="post" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn-delete"
                            onclick="return confirm('متأكد 100% من حذف المقال نهائيًا؟');">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                        حذف المقال
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- المقال نفسه -->
        <article class="article-card single glass-strong">
            <!-- صورة المقال -->
            {% if article.image_url %}
            <div class="article-cover">
                <img src="{{ article.image_url }}" alt="{{ article.title }}" loading="lazy">
            </div>
            {% endif %}

            <!-- العنوان والمعلومات -->
            <header class="article-header">
                <h1 class="article-title">{{ article.title }}</h1>
                <div class="article-meta">
                    <div class="author-info">
                        <svg viewBox="0 0 24 24" width="20" height="20">
                            <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        <strong>{{ article.username }}</strong>
                    </div>
                    <div class="date-info">
                        <svg viewBox="0 0 24 24" width="20" height="20">
                            <path fill="currentColor" d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                        </svg>
                        {{ article.created_at.strftime('%d %B %Y') }}
                        <span class="time">• {{ article.created_at.strftime('%I:%M %p') }}</span>
                    </div>
                </div>
            </header>

            <!-- محتوى المقال -->
            <div class="article-content">
                {{ article.content | newline_to_br | safe }}
            </div>
        </article>

        <!-- قسم التعليقات -->
        <section class="comments-section glass" id="comments">
            <h2 class="section-title">
                التعليقات
                <span class="count">({{ comments|length }})</span>
            </h2>

            <!-- إضافة تعليق جديد -->
            {% if can_comment %}
            <div class="add-comment-card">
                <form action="/articles/{{ article.id }}/comment" method="post" class="comment-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="textarea-wrapper">
                        <textarea name="content" placeholder="شارك رأيك أو تعليقك هنا..." required rows="4" maxlength="1000"></textarea>
                        <small class="char-counter">0/1000</small>
                    </div>
                    <button type="submit" class="btn-submit-comment">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                        إرسال التعليق
                    </button>
                </form>
            </div>
            {% else %}
            <div class="login-prompt glass">
                <p>
                    <a href="/auth/login?next={{ request.path }}" class="login-link">سجّل الدخول</a>
                    لتتمكن من إضافة تعليق
                </p>
            </div>
            {% endif %}

            <!-- قائمة التعليقات -->
            {% if comments %}
            <div class="comments-list">
                {% for c in comments %}
                <div class="comment-item glass" id="comment-{{ c.id }}">
                    <div class="comment-header">
                        <div class="comment-author">
                            <strong>{{ c.username }}</strong>
                            <span class="comment-date">
                                {{ c.created_at.strftime('%d/%m/%Y في %I:%M %p') }}
                            </span>
                        </div>
                        {% if user and (user.role == "admin" or user.id == c.user_id or has_permission(user.id, "delete_comment")) %}
                        <form action="/articles/{{ article.id }}/comment/{{ c.id }}/delete" method="post" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="btn-delete-comment" title="حذف التعليق"
                                    onclick="return confirm('متأكد من حذف التعليق؟');">
                                حذف
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    <div class="comment-body">
                        {{ c.content | newline_to_br | safe }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-comments glass">
                <p>لا توجد تعليقات بعد.. كن أول من يعلق!</p>
            </div>
            {% endif %}
        </section>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // عداد الأحرف في التعليق
    const textarea = document.querySelector('textarea[name="content"]');
    if (textarea) {
        const counter = document.querySelector('.char-counter');
        textarea.addEventListener('input', () => {
            counter.textContent = `${textarea.value.length}/1000`;
        });
    }
</script>
{% endblock %}